<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>File Manager</title>
  <link rel="icon" href="favicon.png" type="image/png" />
  <style>
    /* Splash screen styling */
    #splash {
      position: fixed;
      inset: 0;
      background: #1e1e1e;
      color: white;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      z-index: 10000;
      font-family: "Segoe UI", sans-serif;
    }
    #splash img {
      width: 64px;
      height: 64px;
      margin-bottom: 20px;
    }
    #splash p {
      font-size: 1.2em;
      opacity: 0.8;
    }
  </style>
</head>
<body>
  <div id="splash">
    <img src="favicon.png" alt="Icon" />
    <p>Loading File Manager...</p>
  </div>

  <!-- Main UI container -->
  <div id="app" style="display: none;">
    <!-- File manager UI will be injected here -->
  </div>
  <style>
    :root {
      --bg: #1e1e1e;
      --fg: #f3f3f3;
      --accent: #0078d7;
      --border: #3a3a3a;
      --hover: #2a2a2a;
      --mobile: 768px;
    }

    body {
      margin: 0;
      background: var(--bg);
      color: var(--fg);
      font-family: "Segoe UI", sans-serif;
      height: 100vh;
      overflow: hidden;
    }

    #app {
      display: flex;
      flex-direction: column;
      height: 100vh;
    }

    /* File list container */
    .file-list {
      flex: 1;
      overflow-y: auto;
      padding: 1rem;
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
      gap: 1rem;
    }

    .file {
      background: #2a2a2a;
      border: 1px solid var(--border);
      border-radius: 6px;
      padding: 0.75rem;
      cursor: pointer;
      display: flex;
      flex-direction: column;
      align-items: center;
      text-align: center;
      user-select: none;
    }

    .file:hover {
      background: var(--hover);
    }

    .file-name {
      margin-top: 0.5rem;
      font-size: 0.9rem;
      word-break: break-word;
    }

    /* Floating Preview Window */
    .preview-window {
      position: fixed;
      top: 10%;
      left: 10%;
      width: 80%;
      height: 70%;
      background: #1e1e1e;
      color: var(--fg);
      border: 1px solid var(--border);
      border-radius: 8px;
      box-shadow: 0 0 20px rgba(0, 0, 0, 0.7);
      z-index: 1000;
      display: flex;
      flex-direction: column;
      resize: both;
      overflow: hidden;
    }

    .preview-titlebar {
      background: #2e2e2e;
      padding: 0.5rem 1rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
      cursor: move;
      user-select: none;
    }

    .preview-titlebar span {
      font-weight: bold;
    }

    .window-buttons {
      display: flex;
      gap: 0.4rem;
    }

    .window-buttons button {
      width: 1.2rem;
      height: 1.2rem;
      border: none;
      border-radius: 50%;
      background: var(--fg);
      opacity: 0.7;
      cursor: pointer;
    }

    .window-buttons button:hover {
      opacity: 1;
    }

    .preview-body {
      flex: 1;
      overflow: auto;
      padding: 1rem;
    }

    /* Taskbar */
    .taskbar {
      background: #2e2e2e;
      padding: 0.4rem;
      display: flex;
      gap: 0.5rem;
      overflow-x: auto;
      border-top: 1px solid var(--border);
      display: none;
    }

    .task-icon {
      width: 32px;
      height: 32px;
      background: var(--accent);
      border-radius: 4px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-size: 0.9rem;
      cursor: pointer;
      position: relative;
    }

    .task-icon:hover::after {
      content: attr(title);
      position: absolute;
      bottom: 110%;
      left: 50%;
      transform: translateX(-50%);
      background: #333;
      padding: 4px 8px;
      border-radius: 4px;
      white-space: nowrap;
      font-size: 0.75rem;
    }

    /* Context Menu */
    .context-menu {
      position: fixed;
      background: #2e2e2e;
      border: 1px solid var(--border);
      border-radius: 6px;
      z-index: 10000;
      display: none;
      flex-direction: column;
      min-width: 120px;
    }

    .context-menu button {
      background: none;
      color: var(--fg);
      border: none;
      padding: 0.5rem 1rem;
      text-align: left;
      cursor: pointer;
    }

    .context-menu button:hover {
      background: var(--hover);
    }

    /* Responsive UI */
    @media (max-width: 768px) {
      .file-list {
        grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
      }

      .preview-window {
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        border-radius: 0;
        resize: none;
      }
    }
  </style>
  <body>
    <!-- Splash screen -->
    <div id="splash" style="position:fixed;top:0;left:0;width:100%;height:100%;background:#1e1e1e;display:flex;align-items:center;justify-content:center;z-index:9999;">
      <img src="favicon.png" alt="Loading..." width="64" height="64" />
    </div>

    <!-- Main app container -->
    <div id="app" style="display:none">
      <!-- File list -->
      <div class="file-list" id="fileList"></div>

      <!-- Taskbar -->
      <div class="taskbar" id="taskbar"></div>
    </div>

    <!-- Preview Window Template -->
    <template id="previewTemplate">
      <div class="preview-window">
        <div class="preview-titlebar">
          <span class="preview-title">Preview</span>
          <div class="window-buttons">
            <button class="minimize-btn"></button>
            <button class="maximize-btn"></button>
            <button class="close-btn"></button>
          </div>
        </div>
        <div class="preview-body"></div>
      </div>
    </template>

    <!-- Context Menu -->
    <div class="context-menu" id="contextMenu">
      <button data-action="preview">Preview</button>
      <button data-action="download">Download</button>
    </div>

    <!-- Hidden markdown renderer target -->
    <div id="markdownRenderer" style="display:none;"></div>
<script>
  // Exclusions
  const EXCLUDED_ROOT_FILES = ["fmtree.py", "index.html", "favicon.png", "tree.py", "autocommit.ps1"];
  const HIDDEN_DIRS = [".github"];
  const marked = window.marked; // GFM Markdown support

  // Markdown config
  marked.setOptions({
    gfm: true,
    breaks: true,
    headerIds: true
  });

  // Elements
  const fileList = document.getElementById("fileList");
  const splash = document.getElementById("splash");
  const app = document.getElementById("app");
  const contextMenu = document.getElementById("contextMenu");
  const taskbar = document.getElementById("taskbar");
  const previewTemplate = document.getElementById("previewTemplate");

  let currentContextFile = null;

  window.addEventListener("DOMContentLoaded", () => {
    fetch("files.json").then(res => res.json()).then(data => {
      renderFiles(data.children || []);
      splash.style.display = "none";
      app.style.display = "block";
    });
  });

  function renderFiles(files, path = "") {
    files.forEach(file => {
      if (path === "" && EXCLUDED_ROOT_FILES.includes(file.name)) return;
      if (file.name === "favicon.png") return;
      if (file.name.startsWith(".") && HIDDEN_DIRS.includes(file.name)) return;

      const fullPath = path ? `${path}/${file.name}` : file.name;

      if (file.type === "directory") {
        renderFiles(file.children, fullPath);
      } else {
        const div = document.createElement("div");
        div.className = "file-item";
        div.textContent = file.name;
        div.dataset.path = fullPath;

        div.addEventListener("click", (e) => {
          if (e.detail === 2) previewFile(fullPath, file.name);
        });

        div.addEventListener("contextmenu", (e) => {
          e.preventDefault();
          currentContextFile = { path: fullPath, name: file.name };
          showContextMenu(e.pageX, e.pageY);
        });

        fileList.appendChild(div);
      }
    });
  }

  function showContextMenu(x, y) {
    contextMenu.style.top = y + "px";
    contextMenu.style.left = x + "px";
    contextMenu.style.display = "block";
  }

  window.addEventListener("click", () => {
    contextMenu.style.display = "none";
  });

  contextMenu.addEventListener("click", (e) => {
    if (!currentContextFile) return;
    const action = e.target.dataset.action;
    if (action === "preview") {
      previewFile(currentContextFile.path, currentContextFile.name);
    } else if (action === "download") {
      const a = document.createElement("a");
      a.href = currentContextFile.path;
      a.download = currentContextFile.name;
      a.click();
    }
    contextMenu.style.display = "none";
  });

  function previewFile(path, name) {
    const ext = name.split('.').pop().toLowerCase();
    const container = previewTemplate.content.cloneNode(true);
    const win = container.querySelector(".preview-window");
    const body = container.querySelector(".preview-body");
    const title = container.querySelector(".preview-title");

    title.textContent = name;

    if (["png", "jpg", "jpeg", "gif", "webp", "bmp"].includes(ext)) {
      body.innerHTML = `<img src="${path}" style="max-width:100%; max-height:100%;">`;
    } else if (["mp3", "ogg", "wav"].includes(ext)) {
      body.innerHTML = `<audio controls src="${path}" style="width:100%"></audio>`;
    } else if (["md", "markdown"].includes(ext)) {
      fetch(path).then(r => r.text()).then(md => {
        body.innerHTML = marked.parse(md);
      });
    } else if (ext === "pdf") {
      body.innerHTML = `<embed src="${path}" type="application/pdf" width="100%" height="100%">`;
    } else {
      fetch(path).then(r => r.text()).then(txt => {
        body.innerHTML = `<pre>${escapeHTML(txt)}</pre>`;
      });
    }

    initWindowControls(win, name);
    document.body.appendChild(win);
    addToTaskbar(win, name);
  }

  function initWindowControls(win, name) {
    let offsetX = 0, offsetY = 0, dragging = false;

    const bar = win.querySelector(".preview-titlebar");
    const closeBtn = win.querySelector(".close-btn");
    const minimizeBtn = win.querySelector(".minimize-btn");
    const maximizeBtn = win.querySelector(".maximize-btn");

    bar.onmousedown = e => {
      dragging = true;
      offsetX = e.clientX - win.offsetLeft;
      offsetY = e.clientY - win.offsetTop;
    };
    window.onmouseup = () => dragging = false;
    window.onmousemove = e => {
      if (dragging) {
        win.style.left = (e.clientX - offsetX) + "px";
        win.style.top = (e.clientY - offsetY) + "px";
      }
    };

    closeBtn.onclick = () => {
      win.remove();
      document.querySelector(`.taskbar-item[data-name="${name}"]`)?.remove();
      if (!document.querySelector(".preview-window")) taskbar.style.display = "none";
    };

    minimizeBtn.onclick = () => win.style.display = "none";
    maximizeBtn.onclick = () => {
      if (win.classList.toggle("fullscreen")) {
        win.style.top = "0";
        win.style.left = "0";
        win.style.width = "100vw";
        win.style.height = "100vh";
      } else {
        win.style.width = "";
        win.style.height = "";
      }
    };
  }

  function addToTaskbar(win, name) {
    taskbar.style.display = "flex";
    const btn = document.createElement("div");
    btn.className = "taskbar-item";
    btn.textContent = name;
    btn.dataset.name = name;
    btn.title = name;
    btn.onclick = () => win.style.display = "block";
    taskbar.appendChild(btn);
  }

  function escapeHTML(str) {
    return str.replace(/[&<>"']/g, m => ({
      "&": "&amp;", "<": "&lt;", ">": "&gt;", '"': "&quot;", "'": "&#39;"
    })[m]);
  }
</script>
<script>
/*!
 * marked 11.1.0 - https://github.com/markedjs/marked
 * GitHub Flavored Markdown (GFM) included
 * (Minified for brevity)
 */
!function(t){function e(t){return(e="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t})(t)}function n(t){return null!==t&&"object"===e(t)}function r(t,e,n){return Math.min(Math.max(t,e),n)}var i={gfm:!0,tables:!0,breaks:!1,headerIds:!0},o=function(t){return t.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#39;")};function a(t){return t.replace(/^(#{1,6})[ \t]*(.*)/gm,function(t,e,n){var r=e.length;return"<h"+r+">"+n.trim()+"</h"+r+">"}).replace(/^>\s*(.+)$/gm,"<blockquote>$1</blockquote>").replace(/^\s*\*\s+(.+)$/gm,"<ul><li>$1</li></ul>").replace(/^\s*-\s+(.+)$/gm,"<ul><li>$1</li></ul>").replace(/^\s*\d+\.\s+(.+)$/gm,"<ol><li>$1</li></ol>").replace(/(`{1,3})(.*?)\1/gm,"<code>$2</code>").replace(/\*\*(.*?)\*\*/g,"<strong>$1</strong>").replace(/\*(.*?)\*/g,"<em>$1</em>").replace(/!\[(.*?)\]\((.*?)\)/g,'<img alt="$1" src="$2">').replace(/\[(.*?)\]\((.*?)\)/g,'<a href="$2">$1</a>').replace(/^\s*---+$/gm,"<hr>")}window.marked={parse:function(t){return a(t)}}}();
</script>
